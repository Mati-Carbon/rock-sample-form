<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock Sample Collection Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #mapContainer {
            height: 300px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        /* CSS for the rotating confirmation popup */
        #confirmationPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        #confirmationPopup.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) rotate(360deg); /* Full rotation */
        }

        #confirmationPopup img {
            width: 50px; /* Adjust size as needed */
            height: 50px;
            margin-bottom: 10px;
            animation: rotate 2s linear infinite; /* Rotation animation */
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

    </style>
</head>
<body class="bg-gray-100 p-6 rounded-lg">
    <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
        <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Rock Sample Collection Form</h1>
        <p class="mb-4 text-gray-700">
            Please collect at least approx. 50 gm sample from each site.
            <ul class="list-disc list-inside mb-2">
                <li>Soils: We prefer dry powdered sample collected from a column of soil that is at least 6 inches deep</li>
                <li>Rock: We prefer if the sample were finely crushed powdered samples. If powder is not available small representative rocks are fine.</li>
            </ul>
            Please ensure you take two samples from each site to provide redundancy. Please code each sample with a UNIQUE code and geo tag each sample bag and submit this form for each separate sample.
        </p>
        <form id="rockSampleForm" class="space-y-4">
            <div>
                <label for="rockPhoto" class="block text-gray-700 text-sm font-bold mb-2">Sample Photograph in Bag:</label>
                <input type="file" id="rockPhoto" accept="image/*" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <p id="photoError" class="text-red-500 text-xs italic" style="display: none;"></p>
            </div>
            <div>
                <label for="gpsLocation" class="block text-gray-700 text-sm font-bold mb-2">GPS Location:</label>
                <input type="text" id="gpsLocation" placeholder="Latitude, Longitude" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly>
                 <p id="gpsError" class="text-red-500 text-xs italic" style="display: none;"></p>
                <div id="mapContainer"></div>
                <p class="text-gray-500 text-sm mt-2">Click on the map to select the location.</p>
            </div>
            <div>
                <label for="collectorName" class="block text-gray-700 text-sm font-bold mb-2">Collector Name:</label>
                <input type="text" id="collectorName" placeholder="Enter Collector's Name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <p id="collectorNameError" class="text-red-500 text-xs italic" style="display: none;"></p>
            </div>
            <div>
                <label for="uniqueCode" class="block text-gray-700 text-sm font-bold mb-2">Assigned Unique Code:</label>
                <input type="text" id="uniqueCode" placeholder="Enter Unique Code" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <p id="uniqueCodeError" class="text-red-500 text-xs italic" style="display: none;"></p>
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit Sample Data</button>
            <div id="submissionMessage" class="mt-4 text-green-600 font-semibold" style="display: none;"></divselection-tag>
        </form>
    </div>

    <div id="confirmationPopup">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/4e/Circle_Diagram_-_Loading.gif" alt="Loading...">
        <p>Submitting Data...</p>
    </div>

    <script>
        const mapContainer = L.DomUtil.get('mapContainer');
        let map;
        let marker;
        let baseMapLayer; // To store the current base map layer

        function initMap() {
            map = L.map(mapContainer).setView([0, 20], 4); // Center on Africa, zoom level 4

            // Define the two base map layers.  Include the API key here.
            const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&key=AIzaSyDobA5g3ZpHzphaG4YA0jXsGIu55bY4L1k&x={x}&y={y}&z={z}', {  //  <<<<===== IMPORTANT
                attribution: '© Google Satellite'
            });
            const hybridLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y&key=AIzaSyDobA5g3ZpHzphaG4YA0jXsGIu55bY4L1k&x={x}&y={y}&z={z}', {  //  <<<<===== IMPORTANT
                attribution: '© Google Hybrid'
            });

            // Add the satellite layer to the map initially
            satelliteLayer.addTo(map);
            baseMapLayer = satelliteLayer; // Track the current layer

            // Create a button to toggle between the two layers
            const toggleButton = L.DomUtil.create('div', 'map-toggle-button', mapContainer.parentElement);
            toggleButton.innerHTML = 'Toggle Map View';
            toggleButton.style.backgroundColor = 'white';
            toggleButton.style.color = 'black';
            toggleButton.style.padding = '10px';
            toggleButton.style.borderRadius = '5px';
            toggleButton.style.cursor = 'pointer';
            toggleButton.style.position = 'relative';
            toggleButton.style.top = '310px';
            toggleButton.style.left = '50%';
            toggleButton.style.transform = 'translateX(-50%)';
            toggleButton.style.zIndex = '1000';

            // Adjust the positioning.  Place it *below* the map.
            toggleButton.style.marginTop = '10px'; // Add some margin below the map.
            toggleButton.style.top = 'unset'; // Remove the top positioning.
            toggleButton.style.bottom = '0px';  // position at the bottom of the parent

            // Add a click event to the button to toggle the layers
            toggleButton.addEventListener('click', function() {
                if (baseMapLayer === satelliteLayer) {
                    map.removeLayer(satelliteLayer);
                    hybridLayer.addTo(map);
                    baseMapLayer = hybridLayer;
                } else {
                    map.removeLayer(hybridLayer);
                    satelliteLayer.addTo(map);
                    baseMapLayer = satelliteLayer;
                }
            });

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                document.getElementById('gpsLocation').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([lat, lng]).addTo(map);
            });
        }

        document.getElementById('rockSampleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // Reset error messages
            document.getElementById('photoError').style.display = 'none';
            document.getElementById('gpsError').style.display = 'none';
            document.getElementById('timestampError').style.display = 'none';
            document.getElementById('collectorNameError').style.display = 'none';
            document.getElementById('uniqueCodeError').style.display = 'none';
            // Get form values
            const rockPhoto = document.getElementById('rockPhoto').files[0];
            const gpsLocation = document.getElementById('gpsLocation').value;
            const timestamp = new Date().toISOString();
            const collectorName = document.getElementById('collectorName').value;
            const uniqueCode = document.getElementById('uniqueCode').value;
            let hasErrors = false;
             // Validate Rock Photo
            if (!rockPhoto) {
                document.getElementById('photoError').textContent = 'Please upload a rock sample photograph.';
                document.getElementById('photoError').style.display = 'block';
                hasErrors = true;
            } else if (rockPhoto.size > 5 * 1024 * 1024) {
                document.getElementById('photoError').textContent = 'File size exceeds 5MB limit.';
                document.getElementById('photoError').style.display = 'block';
                hasErrors = true;
            }
            // Validate GPS Location
            if (!gpsLocation) {
                document.getElementById('gpsError').textContent = 'Please select the GPS location on the map.';
                document.getElementById('gpsError').style.display = 'block';
                hasErrors = true;
            } else if (!/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(gpsLocation)) {
                document.getElementById('gpsError').textContent = 'Invalid GPS format. Please use "Latitude, Longitude".';
                document.getElementById('gpsError').style.display = 'block';
                hasErrors = true;
            }
            // Validate Timestamp - Now auto-generated, but we still need to ensure it was generated
            if (!timestamp) {
                document.getElementById('timestampError').textContent = 'Timestamp was not generated.';
                document.getElementById('timestampError').style.display = 'block';
                hasErrors = true;
            }
            // Validate Collector Name
            if (!collectorName) {
                document.getElementById('collectorNameError').textContent = 'Please enter the collector\'s name.';
                document.getElementById('collectorNameError').style.display = 'block';
                hasErrors = true;
            }
            // Validate Unique Code
            if (!uniqueCode) {
                document.getElementById('uniqueCodeError').textContent = 'Please enter the unique code.';
                document.getElementById('uniqueCodeError').style.display = 'block';
                hasErrors = true;
            }
            if (hasErrors) {
                return;
            }
            // 1. Get the image file
            const rockPhotoFile = document.getElementById('rockPhoto').files[0];
            const submissionId =  Math.random().toString(36).substring(2, 9);
            const newPhotoName = `${submissionId}_${rockPhotoFile.name}`;
            // 2. Convert the image to a base64 string
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;
                // 3. Send the data to Google Apps Script
                const formData = new FormData();
                formData.append('rockPhoto', base64data);
                formData.append('gpsLocation', gpsLocation);
                formData.append('timestamp', timestamp);
                formData.append('collectorName', collectorName);
                formData.append('uniqueCode', uniqueCode);
                formData.append('submissionId', submissionId);
                formData.append('newPhotoName', newPhotoName);
                const scriptUrl = "https://script.google.com/macros/s/AKfycbxIbBn4WzA98Onz6PEbp7_x1yMG-6QuN8JZrR_H8K5RuTh_iSoNA6kfA9VxhBCvlimg/exec";  //  <<<<===== IMPORTANT

                // Show the confirmation popup
                const confirmationPopup = document.getElementById('confirmationPopup');
                confirmationPopup.classList.add('show');

                fetch(scriptUrl, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        document.getElementById('submissionMessage').textContent = 'Sample data submitted successfully!';
                        document.getElementById('submissionMessage').style.display = 'block';
                        document.getElementById('rockSampleForm').reset();
                         // Hide the confirmation popup after a delay
                        setTimeout(() => {
                            confirmationPopup.classList.remove('show');
                        }, 3000);
                       
                    } else {
                        alert('Error submitting data: ' + data.error);
                         // Hide the confirmation popup on error as well
                        confirmationPopup.classList.remove('show');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to submit data. Please check your connection and try again.');
                     // Hide the confirmation popup on error
                    confirmationPopup.classList.remove('show');
                });
            };
            reader.readAsDataURL(rockPhotoFile);
        });
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>
